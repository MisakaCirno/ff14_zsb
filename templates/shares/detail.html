{% extends 'base.html' %}
{% load static %}

{% block title %}{{ share.title }} - 详情{% endblock %}

{% block content %}
<div class="container">
    {% if share.status == 'pending' and share.visibility == 'public' %}
    <div class="alert alert-warning mb-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>待审核：</strong> 此分享正在等待管理员审核。在审核通过前，它不会出现在公开列表中，但您可以通过链接分享给他人。
    </div>
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <!-- 预览区域 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-eye"></i> 战术板预览</h5>
                </div>
                <div class="card-body p-0 position-relative">
                    {% if share.is_nsfw %}
                    <div class="spoiler-overlay" id="nsfwOverlay" onclick="revealContent('nsfwOverlay')" style="z-index: 22;">
                        <div class="text-center">
                            <i class="bi bi-exclamation-diamond-fill fs-1 text-danger mb-2"></i>
                            <h5 class="fw-bold">预览图被隐藏</h5>
                            <p class="mb-3">此分享可能包含令人不适的内容</p>
                            <button class="btn btn-outline-light btn-sm">
                                <i class="bi bi-eye"></i> 点击查看
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    {% if share.is_spoiler %}
                    <div class="spoiler-overlay" id="spoilerOverlay" onclick="revealContent('spoilerOverlay')" style="z-index: 21;">
                        <div class="text-center">
                            <i class="bi bi-eye-slash-fill fs-1 mb-2"></i>
                            <h5 class="fw-bold">预览图被隐藏</h5>
                            <p class="mb-3">此分享可能包含剧透内容</p>
                            <button class="btn btn-outline-light btn-sm">
                                <i class="bi bi-eye"></i> 点击查看
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <div class="ratio" style="--bs-aspect-ratio: 75%;">
                        <iframe src="/static/viewer/embed.html#{{ share.strategy_code }}" 
                                style="border: none;"
                                id="previewIframe"
                                class="{% if share.is_spoiler or share.is_nsfw %}blur-content{% endif %}">
                        </iframe>
                    </div>
                </div>
            </div>

            <!-- 详情区域 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-file-text"></i> 详细信息</h5>
                </div>
                <div class="card-body">
                    {% if share.description %}
                    <div class="mb-4">
                        <h6 class="fw-bold">描述</h6>
                        <div class="description-content">
                            {{ share.description|safe }}
                        </div>
                    </div>
                    {% endif %}

                    <div class="mb-4">
                        <h6 class="fw-bold">战术板代码</h6>
                        <div class="input-group">
                            <input type="text" class="form-control strategy-code" id="strategyCode" value="{{ share.strategy_code }}" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyCode(this)">
                                <i class="bi bi-clipboard"></i> 复制
                            </button>
                        </div>
                    </div>

                    <div>
                        <h6 class="fw-bold">分享链接</h6>
                        <div class="input-group">
                            <input type="text" class="form-control" id="shareUrl" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyUrl(this)">
                                <i class="bi bi-link-45deg"></i> 复制链接
                            </button>
                            <button class="btn btn-outline-primary" onclick="generateShareImage()" id="generateBtn">
                                <i class="bi bi-image"></i> 生成分享图
                            </button>
                        </div>
                        <div class="spinner-border spinner-border-sm d-none mt-2" role="status" id="loadingSpinner">
                            <span class="visually-hidden">生成中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 侧边栏 -->
        <div class="col-lg-4">
            <!-- 标题和作者信息 -->
            <div class="card mb-4">
                <div class="card-body">
                    <h4 class="card-title fw-bold mb-3">
                        {% if share.category == 'combat' %}
                        <span class="badge bg-danger fs-6 align-middle me-1">战斗</span>
                        {% else %}
                        <span class="badge bg-success fs-6 align-middle me-1">娱乐</span>
                        {% endif %}
                        {{ share.title }}
                    </h4>
                    
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <i class="bi bi-person-circle fs-3 text-primary"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">
                                {% if share.author %}{{ share.author.profile.get_display_name }}{% else %}匿名用户{% endif %}
                                {% if share.is_original %}
                                <span class="badge bg-success ms-1" style="font-size: 0.7rem;" title="原创内容">原创</span>
                                {% endif %}
                            </h6>
                        </div>
                    </div>

                    <div class="mb-3 text-muted small">
                        <div class="d-flex justify-content-between mb-1">
                            <span><i class="bi bi-calendar3"></i> {{ share.created_at|date:"Y-m-d" }}</span>
                            <span><i class="bi bi-eye"></i> {{ share.views }} 浏览</span>
                        </div>
                        {% if share.visibility != 'public' %}
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-shield-lock"></i> 可见性</span>
                            <span>
                                {% if share.visibility == 'private' %}
                                <span class="badge bg-danger">私有</span>
                                {% elif share.visibility == 'unlisted' %}
                                <span class="badge bg-warning text-dark">不公开</span>
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}

                        {% if share.is_spoiler %}
                        <div class="d-flex justify-content-between mt-1">
                            <span><i class="bi bi-eye-slash"></i> 内容标记</span>
                            <span class="badge bg-secondary">可能包含剧透</span>
                        </div>
                        {% endif %}
                        
                        {% if share.is_nsfw %}
                        <div class="d-flex justify-content-between mt-1">
                            <span><i class="bi bi-exclamation-diamond"></i> 内容标记</span>
                            <span class="badge bg-danger">可能令人不适</span>
                        </div>
                        {% endif %}
                    </div>

                    {% if user == share.author or user.is_staff or user.is_superuser %}
                    <hr>
                    <div class="d-grid gap-2">
                        {% if user == share.author %}
                        <a href="{% url 'edit_share' share.share_id %}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil"></i> 编辑
                        </a>
                        {% endif %}
                        <a href="{% url 'delete_share' share.share_id %}" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> 删除
                        </a>
                    </div>
                    {% endif %}

                    {% if user.is_authenticated and user != share.author %}
                    <hr>
                    <div class="d-grid">
                        <a href="{% url 'report_share' share.share_id %}" class="btn btn-outline-secondary btn-sm text-danger border-danger">
                            <i class="bi bi-flag"></i> 举报此分享
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 免责声明 -->
            <div class="alert alert-light border text-center py-2 mb-4">
                <div class="mb-1">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> 本站内容均由用户上传，仅供参考与交流，不代表本站立场
                    </small>
                </div>
                <div>
                    <small class="text-muted">
                        <i class="bi bi-palette"></i> 网页预览受渲染机制限制，可能与游戏内存在细微差异，请以实装效果为准
                    </small>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> 使用说明</h5>
                </div>
                <div class="card-body">
                    <ol class="small">
                        <li>复制战术板代码</li>
                        <li>在游戏菜单中依次选择：
                            <ul>”小队“-”战术板“-”新建战术板“-”输入分享码“</ul>
                        </li>
                        <li>粘贴分享码到文本框中，或选择“从剪贴板粘贴”</li>
                        <li>点击：“读取” - “保存”</li>
                        <li>随后根据游戏内提示操作即可</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 分享图模态窗口 -->
<div class="modal fade" id="shareImageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-image"></i> 分享图片预览</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4" style="background-color: #f8f9fa;">
                <div class="mb-3">
                    <canvas id="shareCanvas" style="max-width: 100%; height: auto; border: 2px solid #dee2e6; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></canvas>
                </div>
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i> 
                    <strong>提示：</strong>可以使用下方按钮复制或下载图片，也可以右键点击图片另存为
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> 关闭
                </button>
                <button type="button" class="btn btn-primary" onclick="copyShareImage()">
                    <i class="bi bi-clipboard"></i> 复制到剪贴板
                </button>
                <button type="button" class="btn btn-success" onclick="downloadShareImage()">
                    <i class="bi bi-download"></i> 下载图片
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/html2canvas.min.js' %}"></script>
<script src="{% static 'js/qrcode.min.js' %}"></script>
<script>
function revealContent(overlayId) {
    const overlay = document.getElementById(overlayId);
    if (overlay) {
        overlay.style.transition = 'opacity 0.3s';
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.display = 'none';
            
            // Check if any other overlays are still visible
            const overlays = document.querySelectorAll('.spoiler-overlay');
            let hasVisibleOverlay = false;
            
            overlays.forEach(el => {
                if (el.style.display !== 'none') {
                    hasVisibleOverlay = true;
                }
            });
            
            if (!hasVisibleOverlay) {
                const iframe = document.getElementById('previewIframe');
                if (iframe) {
                    iframe.classList.remove('blur-content');
                }
            }
        }, 300);
    }
}

function copyCode(btn) {
    const codeInput = document.getElementById('strategyCode');
    codeInput.select();
    document.execCommand('copy');
    showMessage('代码已复制到剪贴板！', 'success');
    
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> 已复制';
    btn.classList.replace('btn-outline-secondary', 'btn-success');
    setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.classList.replace('btn-success', 'btn-outline-secondary');
    }, 2000);
}

function copyUrl(btn) {
    const urlInput = document.getElementById('shareUrl');
    urlInput.select();
    document.execCommand('copy');
    showMessage('链接已复制到剪贴板！', 'success');
    
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> 已复制';
    btn.classList.replace('btn-outline-secondary', 'btn-success');
    setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.classList.replace('btn-success', 'btn-outline-secondary');
    }, 2000);
}

function calculateRegionComplexity(ctx, x, y, width, height) {
    try {
        const imageData = ctx.getImageData(x, y, width, height);
        const data = imageData.data;
        let score = 0;
        
        // 简单的边缘检测算法 (计算相邻像素差异之和)
        // 步长为4以提高性能
        for (let i = 0; i < data.length; i += 16) {
            // 当前像素亮度
            const r1 = data[i];
            const g1 = data[i+1];
            const b1 = data[i+2];
            const l1 = 0.299 * r1 + 0.587 * g1 + 0.114 * b1;
            
            // 下一个像素亮度 (如果存在)
            if (i + 4 < data.length) {
                const r2 = data[i+4];
                const g2 = data[i+5];
                const b2 = data[i+6];
                const l2 = 0.299 * r2 + 0.587 * g2 + 0.114 * b2;
                score += Math.abs(l1 - l2);
            }
        }
        return score;
    } catch (e) {
        console.warn('无法计算区域复杂度:', e);
        return 0;
    }
}

async function generateShareImage() {
    const btn = document.getElementById('generateBtn');
    const spinner = document.getElementById('loadingSpinner');
    
    // 显示加载状态
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 生成中...';
    spinner.classList.remove('d-none');
    
    let offscreenIframe = null;
    let qrContainer = null;

    try {
        // 1. 创建离屏 iframe 用于固定比例渲染
        // 使用固定尺寸确保不同设备生成图片一致 (4:3 比例)
        const targetWidth = 960;
        const targetHeight = 720;
        
        offscreenIframe = document.createElement('iframe');
        offscreenIframe.style.position = 'fixed';
        offscreenIframe.style.left = '-10000px';
        offscreenIframe.style.top = '0';
        offscreenIframe.style.width = targetWidth + 'px';
        offscreenIframe.style.height = targetHeight + 'px';
        offscreenIframe.style.border = 'none';
        offscreenIframe.style.visibility = 'hidden'; // 避免闪烁，但保持渲染
        
        // 获取当前战术板代码
        const strategyCode = document.getElementById('strategyCode').value;
        offscreenIframe.src = '/static/viewer/embed.html#' + strategyCode;
        
        document.body.appendChild(offscreenIframe);
        
        // 2. 等待 iframe 加载
        await new Promise((resolve, reject) => {
            const timeout = setTimeout(() => reject(new Error('加载超时')), 15000);
            
            offscreenIframe.onload = () => {
                clearTimeout(timeout);
                resolve();
            };
        });
        
        // 注入样式确保铺满
        try {
            const iframeDoc = offscreenIframe.contentDocument || offscreenIframe.contentWindow.document;
            const style = iframeDoc.createElement('style');
            style.textContent = 'body, html { margin: 0; padding: 0; overflow: hidden; width: 100%; height: 100%; }';
            iframeDoc.head.appendChild(style);
        } catch (e) {
            console.warn('无法注入样式到 iframe:', e);
        }
        
        // 3. 等待内部渲染 (给予额外时间让 JS 执行和布局稳定)
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // 4. 使用 html2canvas 截图
        const iframeDoc = offscreenIframe.contentDocument || offscreenIframe.contentWindow.document;
        const canvas = await html2canvas(iframeDoc.body, {
            backgroundColor: '#ffffff',
            scale: 2, // 提高清晰度
            useCORS: true,
            allowTaint: true,
            logging: false,
            width: targetWidth,
            height: targetHeight,
            windowWidth: targetWidth,
            windowHeight: targetHeight,
            x: 0,
            y: 0
        });
        
        // 创建二维码容器
        qrContainer = document.createElement('div');
        // 不要使用 display: none，这会导致在某些情况下（如移动端模拟）二维码无法正确渲染
        qrContainer.style.position = 'absolute';
        qrContainer.style.left = '-9999px';
        qrContainer.style.top = '-9999px';
        qrContainer.style.visibility = 'hidden';
        document.body.appendChild(qrContainer);
        
        // 生成二维码
        const qrCode = new QRCode(qrContainer, {
            text: window.location.href,
            width: 180,
            height: 180,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
        });
        
        // 等待二维码生成
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // 优先尝试获取 canvas 元素（更可靠）
        const qrCanvas = qrContainer.querySelector('canvas');
        let qrImage = null;
        
        if (qrCanvas) {
            qrImage = qrCanvas;
        } else {
            // 降级到 img 元素
            qrImage = qrContainer.querySelector('img');
            if (qrImage && !qrImage.complete) {
                await new Promise((resolve, reject) => {
                    qrImage.onload = resolve;
                    qrImage.onerror = reject;
                    // 设置超时
                    setTimeout(resolve, 1000);
                });
            }
        }
        
        if (!qrImage) {
            throw new Error('二维码生成失败');
        }
        
        // 创建最终的合成画布
        const finalCanvas = document.getElementById('shareCanvas');
        const ctx = finalCanvas.getContext('2d');
        
        // 设置画布大小 - 使用目标尺寸 (960x720) 以减小文件体积
        finalCanvas.width = targetWidth;
        finalCanvas.height = targetHeight;
        
        // 绘制截图作为背景 (缩放到目标尺寸，保持高质量)
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(canvas, 0, 0, targetWidth, targetHeight);
        
        // 二维码参数 - 适配 960x720 的尺寸
        const qrSize = 120;
        const padding = 15;
        const borderRadius = 6;
        
        // 智能位置选择：计算左下角和右下角的图像复杂度（熵值）
        // 选择"较空"（复杂度低）的角落放置二维码，减少遮挡
        const checkSize = qrSize + padding * 2;
        const leftScore = calculateRegionComplexity(ctx, 0, finalCanvas.height - checkSize, checkSize, checkSize);
        const rightScore = calculateRegionComplexity(ctx, finalCanvas.width - checkSize, finalCanvas.height - checkSize, checkSize, checkSize);

        // 默认左下角，如果右下角更空则放右下角
        let x = padding;
        if (rightScore < leftScore) {
            x = finalCanvas.width - qrSize - padding;
        }
        
        const y = finalCanvas.height - qrSize - padding;
        
        ctx.fillStyle = 'rgba(255, 255, 255, 0.98)';
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 8;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 3;
        
        // 绘制圆角矩形
        ctx.beginPath();
        ctx.moveTo(x + borderRadius, y);
        ctx.lineTo(x + qrSize - borderRadius, y);
        ctx.quadraticCurveTo(x + qrSize, y, x + qrSize, y + borderRadius);
        ctx.lineTo(x + qrSize, y + qrSize - borderRadius);
        ctx.quadraticCurveTo(x + qrSize, y + qrSize, x + qrSize - borderRadius, y + qrSize);
        ctx.lineTo(x + borderRadius, y + qrSize);
        ctx.quadraticCurveTo(x, y + qrSize, x, y + qrSize - borderRadius);
        ctx.lineTo(x, y + borderRadius);
        ctx.quadraticCurveTo(x, y, x + borderRadius, y);
        ctx.closePath();
        ctx.fill();
        
        // 重置阴影
        ctx.shadowColor = 'transparent';
        ctx.shadowBlur = 0;
        
        // 添加边框
        ctx.strokeStyle = '#0d6efd';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // 绘制二维码
        const qrPadding = 8;
        ctx.drawImage(qrImage, 
            x + qrPadding, 
            y + qrPadding, 
            qrSize - qrPadding * 2, 
            qrSize - qrPadding * 2
        );
        
        // 添加顶部标题栏
        const headerHeight = 40;
        const gradient = ctx.createLinearGradient(0, 0, finalCanvas.width, 0);
        gradient.addColorStop(0, 'rgba(13, 110, 253, 0.95)');
        gradient.addColorStop(1, 'rgba(102, 126, 234, 0.95)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, finalCanvas.width, headerHeight);
        
        // 添加标题信息 (左侧：标题 by 作者)
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'left';
        
        const shareTitle = "{{ share.title|escapejs }}";
        const shareAuthor = "{% if share.author %}{{ share.author.profile.get_display_name|escapejs }}{% else %}匿名用户{% endif %}";
        
        // 标题部分
        ctx.font = 'bold 20px "Microsoft YaHei", Arial, sans-serif';
        ctx.fillText(shareTitle, 20, 27);
        
        // 作者部分
        const titleWidth = ctx.measureText(shareTitle).width;
        ctx.font = '16px "Microsoft YaHei", Arial, sans-serif';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.fillText(`  by  ${shareAuthor}`, 20 + titleWidth, 27);
        
        // 添加页面链接 (右侧)
        ctx.textAlign = 'right';
        ctx.font = '14px "Microsoft YaHei", Arial, sans-serif';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        // 显示完整链接（去除协议头以节省空间）
        let linkText = window.location.href.replace(/^https?:\/\//, '');
        ctx.fillText(linkText, finalCanvas.width - 20, 27);
        
        // 添加底部提示文字（二维码上方）+ 描边
        ctx.font = 'bold 14px "Microsoft YaHei", Arial, sans-serif';
        ctx.textAlign = 'center';
        
        // 描边
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 3;
        ctx.strokeText('获取代码', x + qrSize / 2, y - 6);
        
        // 文字
        ctx.fillStyle = '#495057';
        ctx.fillText('获取代码', x + qrSize / 2, y - 6);
        
        // 显示模态窗口
        const modal = new bootstrap.Modal(document.getElementById('shareImageModal'));
        modal.show();
        
        // 显示成功提示
        setTimeout(() => {
            showMessage('分享图生成成功！', 'success');
        }, 100);
        
    } catch (error) {
        console.error('生成分享图失败:', error);
        showMessage('生成分享图失败：' + error.message + ' 请确保预览已加载完成后再试', 'danger');
    } finally {
        // 恢复按钮状态
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-image"></i> 生成分享图';
        spinner.classList.add('d-none');
        
        // 清理临时元素
        if (offscreenIframe) {
            document.body.removeChild(offscreenIframe);
        }
        if (qrContainer) {
            document.body.removeChild(qrContainer);
        }
    }
}

async function copyShareImage() {
    try {
        const canvas = document.getElementById('shareCanvas');
        
        // 显示加载提示
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>复制中...';
        
        // 将 canvas 转换为 blob
        canvas.toBlob(async (blob) => {
            try {
                // 尝试使用 Clipboard API
                if (navigator.clipboard && ClipboardItem) {
                    await navigator.clipboard.write([
                        new ClipboardItem({
                            'image/png': blob
                        })
                    ]);
                    
                    // 显示成功提示
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> 已复制！';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-primary');
                        btn.disabled = false;
                    }, 2000);
                } else {
                    // 降级方案：复制 base64 数据
                    const dataUrl = canvas.toDataURL('image/png');
                    const textarea = document.createElement('textarea');
                    textarea.value = dataUrl;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    showMessage('图片数据已复制到剪贴板！（部分浏览器可能需要使用下载功能）', 'warning');
                }
            } catch (err) {
                console.error('复制失败:', err);
                btn.innerHTML = originalText;
                btn.disabled = false;
                showMessage('复制失败，请尝试使用"下载图片"功能，或右键保存图片', 'danger');
            }
        }, 'image/png');
    } catch (error) {
        console.error('复制失败:', error);
        showMessage('复制失败，请尝试使用"下载图片"功能', 'danger');
    }
}

function downloadShareImage() {
    try {
        const canvas = document.getElementById('shareCanvas');
        const link = document.createElement('a');
        const timestamp = new Date().getTime();
        link.download = `zsb-share-{{ share.share_id }}-${timestamp}.png`;
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
        
        // 显示成功提示
        showMessage('图片下载已开始！', 'success');
    } catch (error) {
        console.error('下载失败:', error);
        showMessage('下载失败，请右键点击图片另存为', 'danger');
    }
}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set share URL from window location
        document.getElementById('shareUrl').value = window.location.href;

        // Save visit history
        const shareId = "{{ share.share_id }}";
        const shareTitle = "{{ share.title|escapejs }}";
        const timestamp = new Date().getTime();
        
        try {
            let history = JSON.parse(localStorage.getItem('visitHistory') || '[]');
            
            // Remove existing entry for this share if exists
            history = history.filter(item => item.id !== shareId);
            
            // Add to beginning
            history.unshift({
                id: shareId,
                title: shareTitle,
                timestamp: timestamp
            });
            
            // Limit to 10 items
            if (history.length > 10) {
                history = history.slice(0, 10);
            }
            
            localStorage.setItem('visitHistory', JSON.stringify(history));
            
            // Update dropdown if function exists (it's in base.html)
            if (typeof updateHistoryDropdown === 'function') {
                updateHistoryDropdown();
            }
        } catch (e) {
            console.error('Failed to save history:', e);
        }
    });
</script>
{% endblock %}
